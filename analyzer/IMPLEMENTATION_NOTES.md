# 分析器模块实现说明

## 概述

分析器模块实现了MEG数据处理的信号分析函数，包括功率谱密度计算、信噪比计算和峰值检测。

## 已实现函数

### 1. compute_psd.m

**用途**: 计算MEG信号的功率谱密度

**主要特性**:
- 支持 `pwelch` 和 `periodogram` 两种方法
- 处理单通道和多通道数据
- 可配置窗口长度、重叠和NFFT参数
- 返回频率向量和功率谱密度

**需求**: 2.1  
**属性**: 属性 6 - PSD计算格式

**使用方法**:
```matlab
[frequencies, psd] = compute_psd(data, fs);
[frequencies, psd] = compute_psd(data, fs, 'Method', 'periodogram');
```

### 2. calculate_snr.m

**用途**: 计算目标频率处的信噪比

**主要特性**:
- 计算目标频率周围窄带内的信号功率
- 从相邻频带计算噪声功率
- 返回dB单位的SNR，以及信号和噪声功率
- 可配置信号带宽、噪声带宽和噪声偏移
- 处理单通道和多通道数据

**需求**: 2.2  
**属性**: 属性 7 - 目标频率处的SNR计算

**算法**:
1. 计算信号的PSD
2. 信号功率 = [目标频率 ± 信号带宽/2] 内的平均功率
3. 噪声功率 = 相邻频带内的平均功率 (与信号带偏移)
4. SNR (dB) = 10 * log10(信号功率 / 噪声功率)

**使用方法**:
```matlab
snr_db = calculate_snr(data, fs, 17);  % 17Hz处的SNR
[snr_db, sig_power, noise_power] = calculate_snr(data, fs, 17, 'SignalBandwidth', 1.0);
```

### 3. detect_peak_at_frequency.m

**用途**: 检测目标频率处的频谱峰值

**主要特性**:
- 在目标频率附近的PSD中搜索局部最大值
- 可配置频率容差 (默认 ±0.5Hz)
- 处理边界情况 (小搜索区域、未找到峰值)
- 返回峰值检测状态、频率、功率和索引
- 处理单通道和多通道数据

**需求**: 2.3  
**属性**: 属性 8 - 17Hz峰值检测

**算法**:
1. 计算信号的PSD
2. 定义搜索区域: [目标频率 - 容差, 目标频率 + 容差]
3. 使用 `findpeaks` 或简单最大值查找局部最大值
4. 验证峰值满足最小高度标准 (相对于基线)
5. 如果找到多个峰值，选择最高的峰值

**特殊处理**:
- 如果搜索区域少于3个点，使用简单最大值方法
- 如果 `findpeaks` 未找到峰值，回退到最大值方法
- 使用中值基线以增强对异常值的鲁棒性

**使用方法**:
```matlab
detected = detect_peak_at_frequency(signal, fs, 17);
[detected, freq, power] = detect_peak_at_frequency(signal, fs, 17, 'Tolerance', 1.0);
```

## 测试

### 单元测试

位置: `tests/unit/test_analyzer.m`

测试覆盖:
- 单通道数据的基本功能
- 多通道数据处理
- 边界情况 (无峰值、多个频率)
- 输出格式验证
- 需求符合性

运行测试:
```matlab
addpath('analyzer');
addpath('tests/unit');
test_analyzer
```

### 验证测试

位置: `analyzer/test_requirements_validation.m`

针对特定需求的验证:
- 需求 2.1: PSD计算格式
- 需求 2.2: SNR计算准确性
- 需求 2.3: 17Hz峰值检测在 ±0.5Hz 容差内

运行验证:
```matlab
cd analyzer
test_requirements_validation
```

## 实现决策

### 1. PSD方法选择

默认方法是 `pwelch`，因为:
- 通过平均实现更好的噪声降低
- 对噪声信号的估计更稳定
- MEG信号分析的标准方法

`periodogram` 作为选项可用于:
- 更简单的基于FFT的方法
- 更好的频率分辨率
- 对短信号的更快计算

### 2. SNR计算

使用相邻频带进行噪声估计:
- 避免信号带的污染
- 提供真实的噪声底估计
- 可配置的偏移和带宽以提供灵活性

### 3. 峰值检测鲁棒性

多个回退策略:
1. 尝试使用显著性标准的 `findpeaks`
2. 如果没有峰值，尝试简单最大值方法
3. 处理小搜索区域 (< 3个点)
4. 使用中值基线而不是均值以增强鲁棒性

这确保了即使在以下情况下也能可靠检测:
- 粗糙的频率分辨率
- 低SNR信号
- 多个频率分量

## 依赖项

- MATLAB信号处理工具箱 (用于 `pwelch`, `periodogram`, `findpeaks`)
- MATLAB R2019b或更高版本

## 性能考虑

- PSD计算是大型数据集的瓶颈
- 多通道处理尽可能向量化
- 窗口长度影响频率分辨率和计算时间
- 默认窗口长度 (1秒) 平衡分辨率和速度

## 未来增强

潜在改进:
- 大型多通道数据集的GPU加速
- 基于信号特性的自适应窗口长度
- 多锥度频谱估计以获得更好的统计特性
- 独立通道的并行处理


### 4. detect_triggers.m

**用途**: 检测触发信号中的触发事件

**主要特性**:
- 基于阈值的检测算法
- 上升沿检测 (信号上穿阈值)
- 最小间隔约束以防止重复检测
- 处理边界情况 (空信号、未找到触发)
- 返回检测到的触发点索引

**需求**: 5.3  
**属性**: 属性 21 - 触发检测准确性

**算法**:
1. 识别信号上穿阈值的所有点 (上升沿)
2. 保留第一个触发点
3. 过滤后续触发点: 仅保留距前一个触发点 ≥ min_interval 采样点的触发点
4. 返回过滤后的触发点索引

**使用方法**:
```matlab
threshold = 2.5;
min_interval = round(0.5 * fs);  % 最小间隔500ms
trigger_indices = detect_triggers(trigger_signal, threshold, min_interval);
```

**实现细节**:
- 使用 `diff` 高效检测上升沿
- 向量化的阈值穿越检测
- 最小间隔约束的顺序过滤
- 通过阈值和最小间隔对噪声具有鲁棒性

### 5. extract_epochs.m

**用途**: 基于触发点从连续数据中提取试次时程

**主要特性**:
- 在每个触发点周围提取固定持续时间的时程
- 可配置触发前和触发后时间窗口
- 处理边界情况 (触发点靠近数据边缘)
- 创建相对时间轴，t=0在触发点
- 跳过无效试次并发出警告
- 返回3D数组: 通道 × 采样点 × 试次

**需求**: 5.4  
**属性**: 属性 22 - 时程提取正确性

**算法**:
1. 将时间参数转换为采样点
2. 对于每个触发点:
   - 计算起始和结束索引
   - 检查是否在数据边界内
   - 如果有效则提取试次，否则跳过并发出警告
3. 创建从 -pre_time 到 +post_time 的相对时间轴
4. 返回试次数组和时间轴

**边界处理**:
- 检查每个触发点前后是否有足够的数据
- 跳过太靠近记录开始或结束的触发点
- 为跳过的触发点发出警告
- 仅返回有效试次

**使用方法**:
```matlab
pre_time = 0.2;   % 触发前200ms
post_time = 1.3;  % 触发后1300ms
[trials, trial_times] = extract_epochs(data, trigger_indices, fs, pre_time, post_time);
% trials: N_通道 × N_每试次采样点 × N_试次
% trial_times: 相对时间轴，t=0在触发点
```

### 6. compute_grand_average.m

**用途**: 计算所有试次的总平均 (均值)

**主要特性**:
- 计算试次维度上的算术平均
- 处理多通道数据
- 验证输入维度
- 返回平均诱发响应
- 简单高效的实现

**需求**: 5.5, 6.1  
**属性**: 属性 23 - 总平均计算

**算法**:
1. 验证输入是3D数组 (通道 × 采样点 × 试次)
2. 沿维度3 (试次) 计算均值
3. 返回平均响应 (通道 × 采样点)

**使用方法**:
```matlab
grand_avg = compute_grand_average(trials);
% grand_avg: N_通道 × N_每试次采样点
```

**统计说明**:
总平均是诱发响应分析的金标准。通过对多个试次求平均，随机噪声相互抵消，而时间锁定的响应得以保留。这是Mission 2中收敛性分析的基础。

## 测试

### 单元测试 (已更新)

位置: `tests/unit/test_analyzer.m`

新增测试:
- `test_detect_triggers_basic`: 基本触发检测功能
- `test_detect_triggers_min_interval`: 最小间隔约束
- `test_extract_epochs_basic`: 基本时程提取
- `test_extract_epochs_boundary`: 边界情况处理
- `test_compute_grand_average_basic`: 总平均计算

运行测试:
```matlab
addpath('analyzer');
addpath('tests/unit');
test_analyzer
```

### 集成测试

位置: `analyzer/test_trigger_epoching.m`

完整工作流的综合测试:
1. 使用合成触发信号进行触发检测
2. 使用合成诱发响应进行时程提取
3. 总平均计算
4. 所有步骤的可视化

运行集成测试:
```matlab
cd analyzer
test_trigger_epoching
```

## 实现决策

### 1. 触发检测算法

使用上升沿检测:
- 比简单阈值穿越更鲁棒
- 防止在持续高电平期间重复计数
- 最小间隔约束防止虚假检测
- 高效的向量化实现

### 2. 时程提取边界处理

保守方法:
- 跳过任何会超出数据边界的试次
- 发出警告以保持透明度
- 确保所有返回的试次都有完整数据
- 防止分析中的边缘伪影

考虑的替代方法:
- 零填充: 会引入伪影
- 部分试次: 会使下游分析复杂化
- 选择的方法: 跳过无效试次 (最干净)

### 3. 总平均实现

使用MATLAB内置的 `mean` 函数:
- 数值稳定
- 性能优化
- 适当处理NaN值 (如果存在)
- 简单易维护

## 性能考虑

- 触发检测: O(N)，其中N是信号长度
- 时程提取: O(N_触发点 × 每试次采样点)
- 总平均: O(N_通道 × N_采样点 × N_试次)
- 所有操作都向量化以提高效率
- 内存使用随试次数量扩展

## 未来增强

潜在改进:
- 触发检测的自适应阈值
- 时程提取期间的基线校正
- 鲁棒平均 (中值、修剪均值)
- 大型数据集的并行处理
- 支持可变长度时程
